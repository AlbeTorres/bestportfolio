---
import { getCollection } from 'astro:content'
import Blogpost from '../../components/Blogpost.astro'
import Layout from '../../layouts/Layout.astro'

export async function getStaticPaths() {
  const allPosts = await getCollection('posts')
  const uniqueTags = [...new Set(allPosts.map(post => post.data.tags).flat())]

  return uniqueTags.map(tag => {
    const filteredPosts = allPosts.filter(post => post.data.tags.includes(tag))
    return {
      params: { tag },
      props: { posts: filteredPosts },
    }
  })
}

const { tag } = Astro.params
const { posts } = Astro.props
---

<Layout title={tag}>
  <main>
    <h1 class='text-3xl font-bold my-5'>Posts tagged with {tag}:</h1>
    <ul>
      {
        posts.map(p => (
          <Blogpost
            title={p.data.title}
            img={p.data.image}
            url={p.slug}
            desc={p.data.description}
            tags={p.data.tags}
          />
        ))
      }
    </ul>
  </main>
</Layout>
